<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width">
  <title>RealtimeAPI trial</title>
  <!-- reference to the OpenAI realtime API
    https://platform.openai.com/docs/guides/realtime-webrtc
  -->
  <!-- TODO
    - [ ] add sound when connected/disconnected
    - [x] add status message
    - [x] add API key input
    - [x] get API key from query parameter
    - [ ] add voice selection
    - [ ] add timeout for keeping connection
    - [ ] add datachannel event handler
   -->
  <script src="env/config.js"></script>
  <script src="js/ui_helper.js"></script>
  <script>
    async function getEphemeralKey(apiKey) {
      const r = await fetch("https://api.openai.com/v1/realtime/sessions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${apiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-4o-realtime-preview-2024-12-17",
          voice: "shimmer", 
                  // "alloy", "coral", "sage", "shimmer",    Female
                  //"ash", //"verse", // "ballad", "echo",   Male
        }),
      });
      const data = await r.json();
      // console.log("get ephemeral:", data);
      // console.log("ephemeral key:", data.client_secret);
      return data?.client_secret?.value;
    }

    let peer = null;
    let localStream = null;
    // async function setupClientSecret() {
    //   CLIENT_SECRET = await getEphemeralKey();
    //   console.log("ephemeral key:", CLIENT_SECRET);
    //   updateUI();
    // }

    async function connectRealtimeAPI() {
      // -- check --
      if (peer) {
        console.error("Already connected");
        return;
      }

      // -- get client secret --
      const CLIENT_SECRET = await getEphemeralKey(getApiKey());
      if (!CLIENT_SECRET) {
        console.error("Failed to get client secret");
        return;
      }

      // Create a peer connection
      peer = new RTCPeerConnection();

      // Set up to play remote audio from the model
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      peer.ontrack = e => audioEl.srcObject = e.streams[0];

      // Add local audio track for microphone input in the browser
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: true
      });
      peer.addTrack(localStream.getTracks()[0]);

      // Set up data channel for sending and receiving events
      const dc = peer.createDataChannel("oai-events");
      peer.addEventListener("message", (e) => {
        // Realtime server events appear here!
        console.log(e);
      });

      // Start the session using the Session Description Protocol (SDP)
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      console.log("sending offer:", offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        body: offer.sdp,
        headers: {
          Authorization: `Bearer ${CLIENT_SECRET}`,
          "Content-Type": "application/sdp"
        },
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text(),
      };
      await peer.setRemoteDescription(answer);
      console.log("received answer:", answer);

      setStatus("Connected");
      updateUI();
    }

    function disconnectRealtimeAPI() {
      if (peer) {
        peer.close();
        peer = null;
        CLIENT_SECRET = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      setStatus("Not connected");
      updateUI();
    }




    // --- UI ---
    function updateUI() {
      // if (CLIENT_SECRET) {
      //   disableElementById("setup_button");
      // } else {
      //   enableElementById("setup_button", true);
      // }

      if(peer) {
        disableElementById("connect_button");
        enableElementById("disconnect_button");
      } else {
        enableElementById("connect_button");
        disableElementById("disconnect_button");
      }
    }

    function setStatus(status) {
      const el = document.getElementById("status_div");
      if (el) {
        el.innerText = status;
      }
    }

    function setKeyInput(key) {
      const keyInput = document.getElementById('api_key_input');
      keyInput.value = key;
    }

    function getApiKey() {
      const keyInput = document.getElementById('api_key_input');
      return keyInput.value || API_KEY;
    }
  </script>
</head>
<body>
  <h2>OpenAI RealtimeAPI trial with WebRTC</h2>
  api key: <input type="text" size="20" id="api_key_input" /><br />

  <!--
  <button id="setup_button" onclick="setupClientSecret()">Setup Ephemeral Key</button><br />
  -->

  <button id="connect_button" onclick="connectRealtimeAPI()">Connect Realtime API</button>&nbsp;
  <button id="disconnect_button" onclick="disconnectRealtimeAPI()">Disconnect</button>
  <div id="status_div">not connected</div>
</body>
<script>
  // --- get API key from URL --
  const queryKey = getParamFromQueryString('key');
  setKeyInput(queryKey);

  // --- update UI ---
  updateUI();
</script>
</html>