<!DOCTYPE html>
<html>
<head>
  <title>RealtimeAPI trial</title>
  <!-- reference to the OpenAI realtime API
    https://platform.openai.com/docs/guides/realtime-webrtc
  -->
  <script src="env/config.js"></script>
  <script>
    async function getEphemeralKey() {
      const r = await fetch("https://api.openai.com/v1/realtime/sessions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${API_KEY}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "gpt-4o-realtime-preview-2024-12-17",
          voice: "verse",
        }),
      });
      const data = await r.json();
      // console.log("get ephemeral:", data);
      // console.log("ephemeral key:", data.client_secret);
      return data?.client_secret?.value;
    }

    let peer = null;
    let localStream = null;
    // async function setupClientSecret() {
    //   CLIENT_SECRET = await getEphemeralKey();
    //   console.log("ephemeral key:", CLIENT_SECRET);
    //   updateUI();
    // }

    async function connectRealtimeAPI() {
      // -- check --
      if (peer) {
        console.error("Already connected");
        return;
      }

      // -- get client secret --
      const CLIENT_SECRET = await getEphemeralKey();
      if (!CLIENT_SECRET) {
        console.error("Failed to get client secret");
        return;
      }

      // Create a peer connection
      peer = new RTCPeerConnection();

      // Set up to play remote audio from the model
      const audioEl = document.createElement("audio");
      audioEl.autoplay = true;
      peer.ontrack = e => audioEl.srcObject = e.streams[0];

      // Add local audio track for microphone input in the browser
      localStream = await navigator.mediaDevices.getUserMedia({
        audio: true
      });
      peer.addTrack(localStream.getTracks()[0]);

      // Set up data channel for sending and receiving events
      const dc = peer.createDataChannel("oai-events");
      peer.addEventListener("message", (e) => {
        // Realtime server events appear here!
        console.log(e);
      });

      // Start the session using the Session Description Protocol (SDP)
      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);
      console.log("sending offer:", offer);

      const baseUrl = "https://api.openai.com/v1/realtime";
      const model = "gpt-4o-realtime-preview-2024-12-17";
      const sdpResponse = await fetch(`${baseUrl}?model=${model}`, {
        method: "POST",
        body: offer.sdp,
        headers: {
          Authorization: `Bearer ${CLIENT_SECRET}`,
          "Content-Type": "application/sdp"
        },
      });

      const answer = {
        type: "answer",
        sdp: await sdpResponse.text(),
      };
      await peer.setRemoteDescription(answer);
      console.log("received answer:", answer);

      updateUI();
    }

    function disconnectRealtimeAPI() {
      if (peer) {
        peer.close();
        peer = null;
        CLIENT_SECRET = null;
      }

      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }

      updateUI();
    }

    // --- UI ---
    function updateUI() {
      // if (CLIENT_SECRET) {
      //   disableElement("setup_button");
      // } else {
      //   enableElement("setup_button", true);
      // }

      if(peer) {
        disableElement("connect_button");
        enableElement("disconnect_button", true);
      } else {
        enableElement("connect_button", true);
        disableElement("disconnect_button");
      }
    }

    function enableElement(id, enabled) {
      const el = document.getElementById(id);
      if (el) {
        el.disabled = !enabled;
      }
    }

    function disableElement(id) {
      enableElement(id, false);
    }
  </script>
</head>
<body>
  <h2>RealtimeAPI trial</h2>

  <!--
  <button id="setup_button" onclick="setupClientSecret()">Setup Ephemeral Key</button><br />
  -->

  <button id="connect_button" onclick="connectRealtimeAPI()">Connect Realtime API</button>&nbsp;
  <button id="disconnect_button" onclick="disconnectRealtimeAPI()">Disconnect</button>
</body>
<script>
  updateUI();
</script>
</html>